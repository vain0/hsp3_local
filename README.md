# hsp3_uedit
hsp3 の非公式な編集版です。

コンパイラにHSPTV部門用の最適化機能を付与するのが目標。

## 差分概要
### 最適化機能
* DSプール
  * 文字列リテラル、実数値リテラル、DSに書き込まれる識別子が、重複してDSに書き込まれないようにする。
* 定数式畳み込み
  * ``1 + 2`` や ``M_PI * 2`` のような、定数だけからなる演算式は、コンパイル時に計算される。
  * オーバーヘッドが大きい。
* 型変換関数の畳込み
  * `str`, `double`, `int` は、``0 + x`` の形に変形される。
    * このほうがコードサイズが少ないため。
  * 変換後の式にも定数式畳み込みが作用する。
  * 例: ``str(double(3))`` → ``"3.000000"``
* 終端命令の省略
  * 最後の `stop` 命令は、実行可能なときにだけ出力される。
* `goto` キーワード省略
  * `onexit` などの `goto`/`gosub` キーワードを受け取る命令は、何も書かなければ `goto` 扱いになるので、明示的に書かれた `goto` を削除する。

### 最適化と無関係な機能
* いくつかの標準マクロ
  * `__hsp3_uedit__`
    * `1` に展開される。
    * 本家のコンパイラと区別するため。
  * `__module__`
    * モジュール内なら、そのモジュール名の文字列リテラルに展開される。グローバル領域なら、空文字列リテラルに展開される。
  * `__func__`
    * `#deffunc` などの中なら、そのコマンド名の文字列リテラルに展開される。そうでなければ、空文字列リテラルに展開される。
  * `__include_level__`
    * `#include` の深さ N の位置において、整数リテラル N に展開される。

* 追加のコンパイルオプション
  * ``#cmpopt optshort`` (既定値 0)
    * コストがそこそこ大きい最適化機能を有効化する。
  * ``#cmpopt axiout`` (既定値 0)
    * ax ファイルをテキトーに文字列化したファイルを自動で出力する。

* `#const` で整数に強制変換する。
  * ``#const int INT_PI 3.14`` と書くと、`INT_PI` は整数値 `3` を表す定数として定義される。

* 特殊展開マクロのタグ名(`%t`)を 56 文字までに拡張。

* 前置単項演算子 `!`
  * ``! x`` は ``(x == 0)`` に自動的に変換される。

* 前置単項演算子 ``??``
  * `#if` など、プリプロセス段階の式の中でしか使えない。
  * ``??"x"`` は、識別子 x が定義されていれば `1`、そうでなければ `0` に展開される。

* `{`, `}` はマクロの引数の中で文の区切りになる。
```hsp
#define global unless(%1) if (0 == (%1))
	unless x { mes "x is false." }
```

* 識別子が多重定義されたことでコンパイルエラーが起きたとき、その識別子が定義された位置を出力する。

## リンク
* [OpenHsp](http://dev.onionsoft.net/trac/openhsp)
  * Subversion で管理されている。
  * ここの [rev 753](http://dev.onionsoft.net/trac/openhsp/browser?rev=753) から分流。

* llvm  は submodule としてもつ。
  * [llvm-mirror](https://github.com/llvm-mirror/llvm)
